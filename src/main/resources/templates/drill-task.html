<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演练任务管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin: 0 auto; }
        .form-container { padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        .table-container { margin-top: 20px; }
        .status-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .status-0 { background-color: #6c757d; color: white; }
        .status-1 { background-color: #007bff; color: white; }
        .status-2 { background-color: #28a745; color: white; }
        .status-3 { background-color: #dc3545; color: white; }
        .invalid-feedback { display: block; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-4 mb-4">演练任务管理</h1>

    <!-- 新增/编辑任务表单 -->
    <div class="form-container">
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#taskModal">
            新增任务工单
        </button>

        <!-- 任务模态框 -->
        <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="taskModalLabel">新增任务工单</h5>
                    <form id="taskForm" class="px-4 py-3 needs-validation" novalidate>
                        <input type="hidden" id="id">
                        <div class="mb-3">
                            <label for="taskCode" class="form-label">任务编号</label>
                            <input type="text" class="form-control" id="taskCode" required>
                            <div class="invalid-feedback">请输入任务编号</div>
                        </div>
                        <div class="mb-3">
                            <label for="planId" class="form-label">关联计划</label>
                            <select class="form-control" id="planId" required>
                                <option value="">请选择计划</option>
                            </select>
                            <div class="invalid-feedback">请选择关联计划</div>
                        </div>
                        <div class="mb-3">
                            <label for="taskContent" class="form-label">任务内容</label>
                            <textarea class="form-control" id="taskContent" rows="3" required></textarea>
                            <div class="invalid-feedback">请输入任务内容</div>
                        </div>
                        <div class="mb-3">
                            <label for="assignTo" class="form-label">执行人</label>
                            <input type="text" class="form-control" id="assignTo" required>
                            <div class="invalid-feedback">请输入执行人</div>
                        </div>
                        <div class="mb-3">
                            <label for="dueTime" class="form-label">截止时间</label>
                            <input type="datetime-local" class="form-control" id="dueTime" required>
                            <div class="invalid-feedback">请选择截止时间</div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">任务状态</label>
                            <select class="form-control" id="status" required>
                                <option value="">请选择状态</option>
                                <option value="0">未开始</option>
                                <option value="1">进行中</option>
                                <option value="2">已完成</option>
                                <option value="3">已逾期</option>
                            </select>
                            <div class="invalid-feedback">请选择任务状态</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary" id="saveTaskBtn">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务列表 -->
    <div class="table-container">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th>ID</th>
                <th>任务编号</th>
                <th>关联计划</th>
                <th>执行人</th>
                <th>截止时间</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="taskTableBody"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script>
        const API_URL = "http://localhost:8080/emergency-drill/api/drillTask";
        const PLAN_API_URL = "http://localhost:8080/emergency-drill/api/drillPlan";
        let editMode = false;
        let plans = [];

        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
        } else {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        }

        axios.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401) {
                    alert('登录态失效，请重新登录');
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
                return Promise.reject(error);
            }
        );

        // 格式化日期
        function formatDateTime(dateTime) {
            if (!dateTime) return "";
            const date = new Date(dateTime);
            return date.toISOString().split('.')[0];
        }

        // 加载计划数据
        function loadPlans() {
            return axios.get(PLAN_API_URL + "/list")
                .then(response => {
                    plans = response.data.records || response.data;
                    const planSelect = document.getElementById("planId");
                    planSelect.innerHTML = '<option value="">请选择计划</option>';
                    plans.forEach(plan => {
                        planSelect.innerHTML += `<option value="${plan.id}">${plan.planCode} - ${plan.planName || plan.drillReason}</option>`;
                    });
                    return plans;
                })
                .catch(error => {
                    console.error("加载计划失败:", error);
                    alert("加载计划数据失败，请刷新页面");
                    return [];
                });
        }

        // 初始化表格
        function initTable() {
            axios.get(API_URL + "/list")
                .then(response => {
                    const tasks = response.data.records || response.data;
                    const tbody = document.getElementById("taskTableBody");
                    tbody.innerHTML = "";

                    tasks.forEach(task => {
                        const statusClass = `status-${task.status}`;
                        const statusText = getStatusText(task.status);
                        const planName = plans.find(p => p.id === task.planId)?.planCode || task.planId;

                        tbody.innerHTML += `
                            <tr data-task-id="${task.id}">
                                <td>${task.id}</td>
                                <td>${task.taskCode}</td>
                                <td>${planName}</td>
                                <td>${task.assignTo}</td>
                                <td>${formatDateTime(task.dueTime)}</td>
                                <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-info me-2 edit-btn">编辑</button>
                                    <button class="btn btn-sm btn-danger delete-btn">删除</button>
                                </td>
                            </tr>
                        `;
                    });

                    setupTableEvents();
                })
                .catch(error => {
                    console.error("获取任务列表失败:", error);
                    alert("数据加载失败，请检查网络连接");
                });
        }

        // 设置表格事件委托
        function setupTableEvents() {
            const tbody = document.getElementById("taskTableBody");
            tbody.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('edit-btn')) {
                    const taskId = target.closest('tr').dataset.taskId;
                    editTask(Number(taskId));
                } else if (target.classList.contains('delete-btn')) {
                    const taskId = target.closest('tr').dataset.taskId;
                    deleteTask(Number(taskId));
                }
            });
        }

        // 状态转换
        function getStatusText(status) {
            switch (status) {
                case 0: return "未开始";
                case 1: return "进行中";
                case 2: return "已完成";
                case 3: return "已逾期";
                default: return "未知";
            }
        }

        // 打开模态框
        function openModal(title, task = null) {
            const modalTitle = document.getElementById("taskModalLabel");
            modalTitle.textContent = title;
            document.getElementById("taskForm").reset();
            document.getElementById("taskForm").classList.remove('was-validated');
            editMode = !!task;

            if (task) {
                document.getElementById("id").value = task.id;
                document.getElementById("taskCode").value = task.taskCode;
                document.getElementById("planId").value = task.planId;
                document.getElementById("taskContent").value = task.taskContent;
                document.getElementById("assignTo").value = task.assignTo;
                document.getElementById("dueTime").value = formatDateTime(task.dueTime);
                document.getElementById("status").value = task.status.toString();
            }

            new bootstrap.Modal(document.getElementById("taskModal")).show();
        }

        // 保存任务
        document.getElementById("taskForm").addEventListener("submit", function(e) {
            e.preventDefault();

            // 表单验证
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const planId = document.getElementById("planId").value;
            if (!planId) {
                document.getElementById("planId").classList.add('is-invalid');
                return;
            }

            const formData = {
                id: document.getElementById("id").value,
                taskCode: document.getElementById("taskCode").value,
                planId: parseInt(planId),
                taskContent: document.getElementById("taskContent").value,
                assignTo: document.getElementById("assignTo").value,
                dueTime: document.getElementById("dueTime").value,
                status: parseInt(document.getElementById("status").value),
                createBy: "admin"
            };

            const url = editMode ? `${API_URL}/update` : `${API_URL}/add`;
            const method = editMode ? "put" : "post";

            axios({
                method: method,
                url: url,
                data: formData,
                headers: { "Content-Type": "application/json" }
            })
                .then(() => {
                    alert("操作成功");
                    resetModal();
                    initTable();
                })
                .catch(error => {
                    console.error("操作失败:", error);
                    alert("操作失败，请检查输入内容");
                });
        });

        // 编辑任务
        function editTask(id) {
            axios.get(`${API_URL}/get/${id}`)
                .then(response => {
                    const task = response.data;
                    if (!task) {
                        alert("任务不存在");
                        return;
                    }
                    openModal("编辑任务工单", task);
                })
                .catch(error => {
                    console.error("获取任务详情失败:", error);
                    alert("获取任务详情失败，请重试");
                });
        }

        // 删除任务
        function deleteTask(id) {
            if (confirm("确定要删除此任务吗？")) {
                axios.delete(`${API_URL}/delete/${id}`)
                    .then(() => {
                        alert("删除成功");
                        initTable();
                    })
                    .catch(error => {
                        console.error("删除失败:", error);
                        alert("删除失败，请检查权限或网络连接");
                    });
            }
        }

        // 重置模态框
        function resetModal() {
            editMode = false;
            bootstrap.Modal.getInstance(document.getElementById("taskModal")).hide();
        }

        // 页面加载时初始化
        window.onload = () => {
            loadPlans().then(() => {
                initTable();
            }).catch(error => {
                console.error("初始化失败:", error);
            });
        };
    </script>
</div>
</div>>
</body>
</html>