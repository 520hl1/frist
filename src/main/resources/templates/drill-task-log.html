<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演练任务日志管理</title>
    <!-- 引入外部资源 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <style>
        .container { max-width: 1200px; margin: 0 auto; }
        .log-time { font-size: 0.9rem; color: #6c757d; }
        .operator { font-weight: 500; }
        .log-content { white-space: pre-wrap; word-break: break-word; }
        .card { margin-bottom: 1rem; }
        .search-bar { margin-bottom: 1.5rem; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-4 mb-4">演练任务日志管理</h1>

    <!-- 加载中遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- 搜索筛选区域 -->
    <div class="search-bar">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="taskIdFilter" class="form-label">任务ID</label>
                <input type="number" class="form-control" id="taskIdFilter" placeholder="输入任务ID筛选">
            </div>
            <div class="col-md-4 mb-3">
                <label for="operatorFilter" class="form-label">操作人</label>
                <input type="text" class="form-control" id="operatorFilter" placeholder="输入操作人筛选">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">操作</label>
                <div class="d-flex">
                    <button type="button" class="btn btn-primary me-2" onclick="searchLogs()">
                        <i class="fa fa-search"></i> 搜索
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                        <i class="fa fa-refresh"></i> 重置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增日志按钮 -->
    <div class="mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLogModal">
            <i class="fa fa-plus"></i> 新增日志
        </button>
    </div>

    <!-- 日志列表 -->
    <div id="logsContainer" class="mb-5">
        <!-- 日志内容将通过JS动态加载 -->
        <div class="text-center py-5 text-muted">
            <i class="fa fa-file-text-o" style="font-size: 3rem;"></i>
            <p class="mt-3">暂无日志记录</p>
        </div>
    </div>

    <!-- 分页控件 -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 分页按钮将通过JS动态生成 -->
        </ul>
    </nav>

    <!-- 新增日志模态框 -->
    <div class="modal fade" id="addLogModal" tabindex="-1" aria-labelledby="addLogModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLogModalLabel">新增任务日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addLogForm">
                        <div class="mb-3">
                            <label for="newTaskId" class="form-label">任务ID <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="newTaskId" required>
                        </div>
                        <div class="mb-3">
                            <label for="newOperator" class="form-label">操作人 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newOperator" required>
                        </div>
                        <div class="mb-3">
                            <label for="newLogContent" class="form-label">日志内容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="newLogContent" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newLogTime" class="form-label">日志时间</label>
                            <input type="datetime-local" class="form-control" id="newLogTime">
                            <div class="form-text">不填写则默认为当前时间</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewLog()">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------
    // 全局配置
    // ----------------------
    const API_BASE_URL = 'http://localhost:8080/emergency-drill/api/drillTaskLog';
    let currentPage = 1;
    let totalPages = 1;
    let currentTaskId = null; // 用于任务详情页关联日志

    // ----------------------
    // 登录态校验 & 全局认证头
    // ----------------------
    const token = localStorage.getItem('token');
    if (!token) {
        alert('请先登录');
        window.location.href = 'login.html'; // 跳转登录页
    } else {
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`; // 设置全局 token
    }

    // ----------------------
    // 响应拦截器：统一处理 401 错误
    // ----------------------
    axios.interceptors.response.use(
        (response) => response,
        (error) => {
            if (error.response?.status === 401) {
                alert('登录态失效，请重新登录');
                localStorage.clear(); // 清除失效凭证
                window.location.href = 'login.html';
            }
            return Promise.reject(error);
        }
    );

    // 显示加载中
    function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
    }

    // 隐藏加载中
    function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        // 从URL参数获取taskId（如果存在）
        const urlParams = new URLSearchParams(window.location.search);
        currentTaskId = urlParams.get('taskId');

        if (currentTaskId) {
            document.getElementById('taskIdFilter').value = currentTaskId;
            document.getElementById('taskIdFilter').disabled = true;
        }

        loadLogs();

        // 设置默认日志时间为当前时间
        const now = new Date();
        const formattedDateTime = now.toISOString().slice(0, 16);
        document.getElementById('newLogTime').value = formattedDateTime;
    });

    // 加载日志列表
    function loadLogs() {
        showLoading(); // 显示加载中
        const taskId = document.getElementById('taskIdFilter').value || null;
        const operator = document.getElementById('operatorFilter').value || null;

        axios.get(`${API_BASE_URL}/list`, {
            params: {
                pageNum: currentPage,
                pageSize: 10,
                taskId,
                operator
            }
        })
            .then(response => {
                const logs = response.data.records;
                totalPages = response.data.pages;

                renderLogs(logs);
                renderPagination();
            })
            .catch(error => {
                console.error('加载日志失败:', error);
                alert('加载日志失败，请稍后重试');
            })
            .finally(() => {
                hideLoading(); // 隐藏加载中
            });
    }

    // 渲染日志列表
    function renderLogs(logs) {
        const container = document.getElementById('logsContainer');

        if (logs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fa fa-file-text-o" style="font-size: 3rem;"></i>
                    <p class="mt-3">暂无日志记录</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        logs.forEach(log => {
            const logTime = new Date(log.logTime).toLocaleString();
            const createTime = new Date(log.createTime).toLocaleString();

            const logCard = document.createElement('div');
            logCard.className = 'card';
            logCard.innerHTML = `
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between">
                        <div>
                            <span class="operator">${log.operator}</span>
                            <span class="log-time ms-2">${logTime}</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteLog(${log.id})">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="text-muted">任务ID:</span> ${log.taskId}
                    </div>
                    <div class="log-content p-3 bg-light rounded">
                        ${log.logContent}
                    </div>
                    <div class="mt-3 text-end text-muted small">
                        创建时间: ${createTime}
                    </div>
                </div>
            `;

            container.appendChild(logCard);
        });
    }

    // 渲染分页控件
    function renderPagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        // 只显示当前页附近的页码
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4 && startPage > 1) {
            startPage = Math.max(1, endPage - 4);
        }

        // 添加首页按钮
        if (startPage > 1) {
            addPageButton(1, '首页');
        }

        // 添加前一页按钮
        if (currentPage > 1) {
            addPageButton(currentPage - 1, '上一页');
        }

        // 添加页码按钮
        for (let i = startPage; i <= endPage; i++) {
            addPageButton(i, i.toString(), i === currentPage);
        }

        // 添加下一页按钮
        if (currentPage < totalPages) {
            addPageButton(currentPage + 1, '下一页');
        }

        // 添加尾页按钮
        if (endPage < totalPages) {
            addPageButton(totalPages, '尾页');
        }
    }

    // 添加分页按钮
    function addPageButton(pageNum, text, isActive = false) {
        const pagination = document.getElementById('pagination');
        const li = document.createElement('li');
        li.className = `page-item ${isActive ? 'active' : ''}`;

        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = 'javascript:void(0)';
        a.textContent = text;
        a.onclick = () => {
            if (!isActive) {
                currentPage = pageNum;
                loadLogs();
            }
        };

        li.appendChild(a);
        pagination.appendChild(li);
    }

    // 搜索日志
    function searchLogs() {
        currentPage = 1; // 重置到第一页
        loadLogs();
    }

    // 重置筛选条件
    function resetFilters() {
        document.getElementById('taskIdFilter').value = currentTaskId || '';
        document.getElementById('operatorFilter').value = '';
        currentPage = 1;
        loadLogs();
    }

    // 保存新日志
    function saveNewLog() {
        const taskId = document.getElementById('newTaskId').value;
        const operator = document.getElementById('newOperator').value;
        const logContent = document.getElementById('newLogContent').value;
        const logTime = document.getElementById('newLogTime').value;

        if (!taskId || !operator || !logContent) {
            alert('请填写必填字段');
            return;
        }

        const logData = {
            taskId: parseInt(taskId),
            operator,
            logContent,
            logTime: logTime ? logTime + ':00' : null // 添加秒数
        };

        axios.post(`${API_BASE_URL}/add`, logData)
            .then(() => {
                alert('日志添加成功');
                document.getElementById('addLogForm').reset();
                document.getElementById('addLogModal').querySelector('.btn-close').click();
                loadLogs();
            })
            .catch(error => {
                console.error('添加日志失败:', error);
                alert('添加日志失败，请检查输入');
            });
    }

    // 删除日志
    function deleteLog(logId) {
        if (confirm('确定要删除这条日志吗？此操作不可撤销')) {
            axios.delete(`${API_BASE_URL}/delete/${logId}`)
                .then(() => {
                    alert('日志删除成功');
                    loadLogs();
                })
                .catch(error => {
                    console.error('删除日志失败:', error);
                    alert('删除日志失败，请稍后重试');
                });
        }
    }
</script>
</body>
</html>