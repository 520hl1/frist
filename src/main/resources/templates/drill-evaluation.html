<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演练评估管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin: 0 auto; }
        .form-container { padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        .table-container { margin-top: 20px; }
        .evaluation-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: white;
        }
        .tag-excellent { background-color: #28a745; } /* 优秀 */
        .tag-good { background-color: #20c997; } /* 良好 */
        .tag-fair { background-color: #ffc107; } /* 一般 */
        .tag-poor { background-color: #dc3545; } /* 较差 */
        .invalid-feedback { display: block; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-4 mb-4">演练评估管理</h1>

    <!-- 筛选条件 -->
    <div class="form-container">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="filterPlanId" class="form-label">关联预案</label>
                <select class="form-control" id="filterPlanId">
                    <option value="">全部预案</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="filterEvaluator" class="form-label">评估人</label>
                <input type="text" class="form-control" id="filterEvaluator" placeholder="请输入评估人">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">操作</label>
                <div>
                    <button type="button" class="btn btn-primary me-2" onclick="searchEvaluations()">
                        <i class="fa fa-search"></i> 搜索
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                        <i class="fa fa-refresh"></i> 重置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑评估表单 -->
    <div class="form-container">
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#evaluationModal">
            <i class="fa fa-plus"></i> 新增评估
        </button>

        <div class="modal fade" id="evaluationModal" tabindex="-1" aria-labelledby="evaluationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="evaluationForm" class="px-4 py-3 needs-validation" novalidate>
                        <input type="hidden" id="id">
                        <input type="hidden" name="createBy" value="admin"> <!-- 后续需改为动态用户 -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="evaluationModalLabel">新增演练评估</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="planId" class="form-label">关联预案 <span class="text-danger">*</span></label>
                                    <select class="form-control" id="planId" required>
                                        <option value="">请选择预案</option>
                                    </select>
                                    <div class="invalid-feedback">请选择关联预案</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="evaluator" class="form-label">评估人 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="evaluator" required>
                                    <div class="invalid-feedback">请输入评估人</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="evaluationTime" class="form-label">评估时间 <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="evaluationTime" required>
                                    <div class="invalid-feedback">请选择评估时间</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="evaluationLevel" class="form-label">评估等级 <span class="text-danger">*</span></label>
                                    <select class="form-control" id="evaluationLevel" required>
                                        <option value="">请选择等级</option>
                                        <option value="优秀">优秀</option>
                                        <option value="良好">良好</option>
                                        <option value="一般">一般</option>
                                        <option value="较差">较差</option>
                                    </select>
                                    <div class="invalid-feedback">请选择评估等级</div>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="evaluationContent" class="form-label">评估内容 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="evaluationContent" rows="3" required></textarea>
                                    <div class="invalid-feedback">请输入评估内容</div>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="problems" class="form-label">发现问题 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="problems" rows="3" required></textarea>
                                    <div class="invalid-feedback">请输入发现的问题</div>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="improvementSuggestions" class="form-label">改进建议 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="improvementSuggestions" rows="3" required></textarea>
                                    <div class="invalid-feedback">请输入改进建议</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary" id="saveEvaluationBtn">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 评估列表 -->
    <div class="table-container">
        <div class="d-flex justify-content-between mb-3">
            <h5>评估列表</h5>
            <div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()">
                    <i class="fa fa-trash"></i> 批量删除
                </button>
            </div>
        </div>
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>ID</th>
                <th>关联预案</th>
                <th>评估人</th>
                <th>评估时间</th>
                <th>评估等级</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="evaluationTableBody"></tbody>
        </table>

        <!-- 分页控件 -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">共 <span id="totalCount">0</span> 条记录</div>
            <nav>
                <ul class="pagination" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <!-- 详情模态框 -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">评估详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailContent">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></script>
    <script>
        // ----------------------
        // 全局配置
        // ----------------------
        const API_URL = "http://localhost:8080/emergency-drill/api/drillEvaluation";
        const PLAN_API_URL = "http://localhost:8080/emergency-drill/api/drillPlan";
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let selectedIds = [];
        let plans = [];

        // ----------------------
        // 登录态校验 & 全局认证头
        // ----------------------
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
        } else {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        }

        // ----------------------
        // 响应拦截器：处理 401 错误
        // ----------------------
        axios.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401) {
                    alert('登录态失效，请重新登录');
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
                return Promise.reject(error);
            }
        );

        // 页面初始化
        window.onload = () => {
            loadPlans();
            loadEvaluations();
            initEventListeners();
        };

        // 加载预案列表
        function loadPlans() {
            axios.get(PLAN_API_URL + "/list")
                .then(response => {
                    plans = response.data;
                    const planSelect = document.getElementById("planId");
                    const filterPlanSelect = document.getElementById("filterPlanId");

                    planSelect.innerHTML = '<option value="">请选择预案</option>';
                    filterPlanSelect.innerHTML = '<option value="">全部预案</option>';

                    plans.forEach(plan => {
                        planSelect.innerHTML += `<option value="${plan.id}">${plan.planCode} - ${plan.planName}</option>`;
                        filterPlanSelect.innerHTML += `<option value="${plan.id}">${plan.planCode} - ${plan.planName}</option>`;
                    });
                })
                .catch(error => console.error("加载预案失败:", error));
        }

        // 加载评估列表
        function loadEvaluations() {
            axios.get(API_URL + "/list", {
                params: {
                    pageNum: currentPage,
                    pageSize: pageSize,
                    planId: document.getElementById("filterPlanId").value || undefined,
                    evaluator: document.getElementById("filterEvaluator").value || undefined
                }
            })
                .then(response => {
                    const { records, pages, total } = response.data;
                    renderEvaluationsTable(records);
                    renderPagination(pages);
                    document.getElementById("totalCount").textContent = total;
                })
                .catch(error => console.error("加载评估失败:", error));
        }

        // 渲染表格
        function renderEvaluationsTable(evaluations) {
            const tbody = document.getElementById("evaluationTableBody");

            if (evaluations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fa fa-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                                <p class="text-muted">暂无评估数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = evaluations.map(evaluation => {
                const plan = plans.find(p => p.id === evaluation.planId) || { planCode: "未知", planName: "未知" };
                const levelClass = getLevelClass(evaluation.evaluationLevel);
                return `
                    <tr>
                        <td><input type="checkbox" class="select-item" value="${evaluation.id}"></td>
                        <td>${evaluation.id}</td>
                        <td>${plan.planCode} - ${plan.planName}</td>
                        <td>${evaluation.evaluator}</td>
                        <td>${new Date(evaluation.evaluationTime).toLocaleString()}</td>
                        <td><span class="evaluation-tag ${levelClass}">${evaluation.evaluationLevel}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-2" onclick="viewDetail(${evaluation.id})">
                                <i class="fa fa-eye"></i> 查看
                            </button>
                            <button class="btn btn-sm btn-warning me-2" onclick="editEvaluation(${evaluation.id})">
                                <i class="fa fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvaluation(${evaluation.id})">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 获取评估等级样式
        function getLevelClass(level) {
            switch (level) {
                case "优秀": return "tag-excellent";
                case "良好": return "tag-good";
                case "一般": return "tag-fair";
                case "较差": return "tag-poor";
                default: return "";
            }
        }

        // 渲染分页控件
        function renderPagination(totalPages) {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            // 计算显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(startPage + 4, totalPages);

            if (endPage - startPage < 4 && startPage > 1) {
                startPage = Math.max(1, endPage - 4);
            }

            // 添加首页按钮
            addPageItem(1, "首页");

            // 添加前一页按钮
            if (currentPage > 1) {
                addPageItem(currentPage - 1, "上一页");
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                addPageItem(i, i.toString(), i === currentPage);
            }

            // 添加下一页按钮
            if (currentPage < totalPages) {
                addPageItem(currentPage + 1, "下一页");
            }

            // 添加尾页按钮
            addPageItem(totalPages, "尾页");
        }

        // 添加分页项
        function addPageItem(pageNum, text, isActive = false) {
            const pagination = document.getElementById("pagination");
            const li = document.createElement("li");
            li.className = `page-item ${isActive ? 'active' : ''}`;

            const a = document.createElement("a");
            a.className = "page-link";
            a.href = "javascript:void(0)";
            a.textContent = text;
            a.onclick = () => {
                if (!isActive) {
                    currentPage = pageNum;
                    loadEvaluations();
                }
            };

            li.appendChild(a);
            pagination.appendChild(li);
        }

        // 初始化事件监听
        function initEventListeners() {
            // 全选/取消全选
            document.getElementById("selectAll").addEventListener("change", function() {
                const checkboxes = document.querySelectorAll(".select-item");
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedIds();
            });

            // 单个选择框变化时更新选中ID列表
            document.addEventListener("change", function(e) {
                if (e.target.classList.contains("select-item")) {
                    updateSelectedIds();
                }
            });

            // 表单提交处理
            document.getElementById("evaluationForm").addEventListener("submit", function(e) {
                e.preventDefault();

                // 表单验证
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                saveEvaluation();
            });
        }

        // 更新选中的ID列表
        function updateSelectedIds() {
            const checkboxes = document.querySelectorAll(".select-item:checked");
            selectedIds = Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
        }

        // 搜索评估
        function searchEvaluations() {
            currentPage = 1; // 重置到第一页
            loadEvaluations();
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById("filterPlanId").value = "";
            document.getElementById("filterEvaluator").value = "";
            currentPage = 1;
            loadEvaluations();
        }

        // 打开新增评估模态框
        function openAddModal() {
            document.getElementById("evaluationModalLabel").textContent = "新增演练评估";
            document.getElementById("evaluationForm").reset();
            document.getElementById("evaluationForm").classList.remove('was-validated');
            document.getElementById("id").value = "";

            // 设置默认值为当前时间
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.getElementById("evaluationTime").value = formattedDateTime;

            new bootstrap.Modal(document.getElementById("evaluationModal")).show();
        }

        // 查看评估详情
        function viewDetail(id) {
            axios.get(`${API_URL}/get/${id}`)
                .then(response => {
                    const evaluation = response.data;
                    const plan = plans.find(p => p.id === evaluation.planId) || { planCode: "未知", planName: "未知" };

                    const detailContent = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <p><strong>关联预案:</strong> ${plan.planCode} - ${plan.planName}</p>
                                <p><strong>评估人:</strong> ${evaluation.evaluator}</p>
                                <p><strong>评估时间:</strong> ${new Date(evaluation.evaluationTime).toLocaleString()}</p>
                                <p><strong>评估等级:</strong> <span class="evaluation-tag ${getLevelClass(evaluation.evaluationLevel)}">${evaluation.evaluationLevel}</span></p>
                                <p><strong>创建时间:</strong> ${new Date(evaluation.createTime).toLocaleString()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <p><strong>评估内容:</strong></p>
                                <p class="bg-light p-3 rounded">${evaluation.evaluationContent}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <p><strong>发现问题:</strong></p>
                            <p class="bg-light p-3 rounded">${evaluation.problems}</p>
                        </div>
                        <div class="mb-3">
                            <p><strong>改进建议:</strong></p>
                            <p class="bg-light p-3 rounded">${evaluation.improvementSuggestions}</p>
                        </div>
                    `;

                    document.getElementById("detailContent").innerHTML = detailContent;
                    document.getElementById("detailModalLabel").textContent = `评估详情 #${evaluation.id}`;
                    new bootstrap.Modal(document.getElementById("detailModal")).show();
                })
                .catch(error => {
                    console.error("获取评估详情失败:", error);
                    alert("获取评估详情失败，请重试");
                });
        }

        // 编辑评估
        function editEvaluation(id) {
            axios.get(`${API_URL}/get/${id}`)
                .then(response => {
                    const evaluation = response.data;

                    document.getElementById("evaluationModalLabel").textContent = "编辑演练评估";
                    document.getElementById("evaluationForm").reset();
                    document.getElementById("evaluationForm").classList.remove('was-validated');

                    document.getElementById("id").value = evaluation.id;
                    document.getElementById("planId").value = evaluation.planId;
                    document.getElementById("evaluator").value = evaluation.evaluator;
                    document.getElementById("evaluationTime").value = evaluation.evaluationTime.slice(0, 16);
                    document.getElementById("evaluationLevel").value = evaluation.evaluationLevel;
                    document.getElementById("evaluationContent").value = evaluation.evaluationContent;
                    document.getElementById("problems").value = evaluation.problems;
                    document.getElementById("improvementSuggestions").value = evaluation.improvementSuggestions;

                    new bootstrap.Modal(document.getElementById("evaluationModal")).show();
                })
                .catch(error => {
                    console.error("获取评估详情失败:", error);
                    alert("获取评估详情失败，请重试");
                });
        }

        // 保存评估
        function saveEvaluation() {
            const formData = {
                id: document.getElementById("id").value || null,
                planId: parseInt(document.getElementById("planId").value),
                evaluator: document.getElementById("evaluator").value,
                evaluationTime: document.getElementById("evaluationTime").value,
                evaluationLevel: document.getElementById("evaluationLevel").value,
                evaluationContent: document.getElementById("evaluationContent").value,
                problems: document.getElementById("problems").value,
                improvementSuggestions: document.getElementById("improvementSuggestions").value
            };

            const url = formData.id ? `${API_URL}/update` : `${API_URL}/add`;
            const method = formData.id ? "put" : "post";

            axios({
                method: method,
                url: url,
                data: formData,
                headers: { "Content-Type": "application/json" }
            })
                .then(() => {
                    alert("操作成功");
                    document.getElementById("evaluationModal").querySelector(".btn-close").click();
                    loadEvaluations();
                })
                .catch(error => {
                    console.error("操作失败:", error);
                    alert("操作失败，请检查输入内容或网络连接");
                });
        }

        // 删除单个评估
        function deleteEvaluation(id) {
            if (confirm("确定要删除此评估吗？此操作不可撤销！")) {
                axios.delete(`${API_URL}/delete/${id}`)
                    .then(() => {
                        alert("删除成功");
                        loadEvaluations();
                    })
                    .catch(error => {
                        console.error("删除失败:", error);
                        alert("删除失败，请检查权限或网络连接");
                    });
            }
        }

        // 批量删除评估
        function deleteSelected() {
            if (selectedIds.length === 0) {
                alert("请先选择要删除的评估");
                return;
            }

            if (confirm(`确定要删除选中的 ${selectedIds.length} 条评估数据吗？此操作不可撤销！`)) {
                axios.delete(`${API_URL}/deleteBatch`, {
                    data: selectedIds
                })
                    .then(() => {
                        alert("批量删除成功");
                        document.getElementById("selectAll").checked = false;
                        selectedIds = [];
                        loadEvaluations();
                    })
                    .catch(error => {
                        console.error("批量删除失败:", error);
                        alert("批量删除失败，请检查权限或网络连接");
                    });
            }
        }
    </script>
</div>
</body>
</html>