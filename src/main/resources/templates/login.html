<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统登录</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 400px; margin: 100px auto; }
        .form-container { padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .error-message { color: red; margin-top: 10px; text-align: center; }
        .spinner-border { display: none; } /* 初始隐藏加载 spinner */
    </style>
</head>
<body>
<div class="container">
    <div class="form-container">
        <h2 class="mb-4 text-center">系统登录</h2>

        <form id="loginForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="username" class="form-label">用户名</label>
                <input type="text" class="form-control" id="username" required placeholder="请输入用户名">
                <div class="invalid-feedback">请填写用户名</div>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">密码</label>
                <input type="password" class="form-control" id="password" required placeholder="请输入密码">
                <div class="invalid-feedback">请填写密码</div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary w-100">
                    登录 <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
            </div>

            <div id="errorMessage" class="error-message mt-3"></div>
        </form>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.4.0/axios.min.js"></script>
<script>
    // 配置后端接口地址（需与后端实际路径一致）
    const API_URL = "http://localhost:8080/emergency-drill/api/sysUser/login"; // 示例路径，根据实际修改
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('errorMessage');
    const submitButton = document.querySelector('button[type="submit"]');
    const spinner = submitButton.querySelector('.spinner-border');

    // 初始化验证状态
    loginForm.addEventListener('input', () => {
        loginForm.classList.remove('was-validated');
        errorMessage.textContent = '';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // 阻止表单默认 GET 提交
        submitButton.disabled = true; // 禁用按钮防止重复提交
        spinner.style.display = 'inline-block'; // 显示加载动画

        try {
            // 表单验证
            if (!loginForm.checkValidity()) {
                loginForm.classList.add('was-validated');
                throw new Error('请填写完整登录信息');
            }

            // 发送 POST 请求
            const response = await axios.post(
                API_URL,
                {
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                },
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache' // 禁止缓存
                    }
                }
            );

            // 处理响应
            if (response.status === 200) {
                if (response.data.success) {
                    // 登录成功逻辑（示例）
                    localStorage.setItem('token', response.data.data.token);
                    localStorage.setItem('user', JSON.stringify(response.data.data.user));
                    alert('登录成功！');
                    window.location.href = 'index.html'; // 重定向到主页
                } else {
                    throw new Error(response.data.message || '登录失败');
                }
            } else {
                throw new Error(`服务器返回状态码：${response.status}`);
            }

        } catch (error) {
            console.error('登录请求失败:', error);
            errorMessage.textContent = '';

            if (error.response) {
                const { status, data } = error.response;
                switch (status) {
                    case 400:
                        errorMessage.textContent = '参数错误：' + (data.message || '请检查用户名或密码');
                        break;
                    case 401:
                        errorMessage.textContent = '认证失败：用户名或密码错误';
                        break;
                    case 405:
                        errorMessage.textContent = '错误：不支持的请求方法（必须使用 POST）';
                        break;
                    case 500:
                        errorMessage.textContent = '服务器内部错误：' + (data.message || '请联系管理员');
                        break;
                    default:
                        errorMessage.textContent = `请求失败（状态码 ${status}）：${data.message || '未知错误'}`;
                }
            } else if (error.message.includes('Network Error')) {
                errorMessage.textContent = '网络连接失败，请检查网络';
            } else {
                errorMessage.textContent = '登录失败：' + error.message;
            }

        } finally {
            submitButton.disabled = false; // 恢复按钮状态
            spinner.style.display = 'none'; // 隐藏加载动画
        }
    });

    // 调试：检查 Axios 加载状态
    console.log('Axios 库加载状态:', typeof axios !== 'undefined' ? '正常' : '异常');
</script>
</body>
</html>